version: "3.1"
services:
  mariadb:
    image: mariadb
    volumes:
      - db_vol:/var/lib/mysql
    secrets:
      - whir_db_password
      - root_db_password
    environment:
      - MYSQL_USER=whir
      - MYSQL_DATABASE=whir
      - MYSQL_PASSWORD_FILE=/run/secrets/whir_db_password
      - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/root_db_password
    networks:
      - whirnet
    deploy:
      placement:
          constraints: [node.role == manager]
      replicas: 1
      restart_policy:
        condition: on-failure
  whir-parser:
      # replace username/repo:tag with your name and image details
        image: whir
        deploy:
          replicas: 1
          resources:
            limits:
              cpus: "0.5"
              memory: 128M
          restart_policy:
            condition: on-failure
          placement:
            constraints: [node.role == manager]
        command: "while true; do /usr/bin/python3 create_msg_in_db.py; sleep 900; done"
        volumes:
                - "files_vol:/data"
        secrets:
                - whir_db_password
        environment:
                - WHIR_DB_USER=whir
                - WHIR_DB_NAME=whir
                - WHIR_DB_PASSWORD_FILE=/run/secrets/whir_db_password
                - WHIR_DB_HOST=mariadb
        networks:
                - whirnet
  whir-decomposer:
      # replace username/repo:tag with your name and image details
        image: whir
        deploy:
          replicas: 4
          resources:
            limits:
              cpus: "0.5"
              memory: 1G
          restart_policy:
            condition: on-failure
          placement:
            constraints: [node.role == manager]
        command: "/usr/bin/python3 decomposer.py"
        volumes:
                - "files_vol:/data"
        secrets:
                - whir_db_password
        environment:
                - WHIR_DB_USER=whir
                - WHIR_DB_NAME=whir
                - WHIR_DB_PASSWORD_FILE=/run/secrets/whir_db_password
                - WHIR_DB_HOST=mariadb
        networks:
                - whirnet
secrets:
        whir_db_password:
                external: true
        root_db_password:
                external: true
        
volumes:
        db_vol:
        files_vol:
networks:
        whirnet:
